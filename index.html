<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Halloween Potluck Sheet</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous" />
    <style>
        body { background:#0f0f13; color:#e9e9ee; }
        .card { background:#15151b; border:1px solid #2a2a35; }
        .table { color:#e9e9ee; }
        .table thead th { border-bottom: 2px solid #2a2a35; }
        .table td, .table th { border-color:#2a2a35; }
        .form-control { background:#1a1a22; border-color:#2a2a35; color:#e9e9ee; }
        .form-control::placeholder{ color:#8b8b98; }
        .btn-primary { background:#7c5cff; border-color:#7c5cff; }
        .btn-outline-danger { border-color:#ff5c7a; color:#ff5c7a; }
        .btn-outline-danger:hover { background:#ff5c7a; color:#fff; }
        .muted { color:#9a9aa8; }
    </style>
</head>
<body>
<div class="container py-5">
    <div class="row">
        <div class="col-12 col-lg-8 mx-auto">
            <div class="card shadow-sm rounded-xl">
                <div class="card-body">
                    <h1 class="h3 text-center mb-4">ðŸŽƒ Halloween Potluck Sheet for the Gang</h1>
                    <form id="form" class="mb-4" autocomplete="off">
                        <div class="form-row">
                            <div class="form-group col-12 col-md-5">
                                <label for="name">Who are you?</label>
                                <input type="text" id="name" class="form-control" placeholder="Your esteemed title, my liege:" required />
                            </div>
                            <div class="form-group col-12 col-md-5">
                                <label for="bringing">What are you bringing?</label>
                                <input type="text" id="bringing" class="form-control" placeholder="The business" required />
                            </div>
                            <div class="form-group col-12 col-md-2 d-flex align-items-end">
                                <button id="btn" type="submit" class="btn btn-primary btn-block">Send it!</button>
                            </div>
                        </div>
                    </form>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-bordered mb-0">
                            <thead>
                            <tr>
                                <th style="width:30%">Name</th>
                                <th>Item</th>
                                <th style="width:110px">Actions</th>
                            </tr>
                            </thead>
                            <tbody id="tbody">
                            <tr id="empty-row"><td colspan="3" class="text-center muted">Nobody is bringing shit yet. (You're number 1!!!) ðŸ‘»</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script>
  // --- Firebase config ---
  const firebaseConfig = {
    apiKey: "AIzaSyC62lmq3vzrBhQxM-cfU0EW8fGLsKi2kaw",
    authDomain: "potluck-b3403.firebaseapp.com",
    projectId: "potluck-b3403",
    storageBucket: "potluck-b3403.firebasestorage.app",
    messagingSenderId: "809910637115",
    appId: "1:809910637115:web:4d054ee730a030f200421e"
  };

  // --- Initialize Firebase ---
  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.database();
  const itemsRef = db.ref("potluck/items");

  const form = document.getElementById("form");
  const nameInput = document.getElementById("name");
  const itemInput = document.getElementById("bringing");
  const tbody = document.getElementById("tbody");
  const submitBtn = document.getElementById("btn");
  let emptyRow = document.getElementById("empty-row");

  // Disable submit until signed in
  submitBtn.disabled = true;

  let subscribed = false; // prevent double-binding listeners

  auth.onAuthStateChanged(async (user) => {
    console.log("auth user:", user && user.uid);
    submitBtn.disabled = !user;
    if (!user) return;

    // 1) One-time load of current data
    tbody.innerHTML = ""; // clear
    emptyRow = null;
    const snap = await itemsRef.once("value");
    if (!snap.exists()) {
      showEmptyState();
    } else {
      snap.forEach(child => renderRow(child.key, child.val()));
    }

    // 2) Attach live listeners (only once)
    if (!subscribed) {
      subscribed = true;

      itemsRef.on("child_added", s => {
        if (!tbody.querySelector(`tr[data-key="${s.key}"]`)) {
          renderRow(s.key, s.val());
        }
      });

      itemsRef.on("child_removed", s => {
        const tr = tbody.querySelector(`tr[data-key="${s.key}"]`);
        if (tr) tr.remove();
        showEmptyState();
      });

      itemsRef.on("child_changed", s => {
        const tr = tbody.querySelector(`tr[data-key="${s.key}"]`);
        if (tr) {
          const v = s.val();
          tr.children[0].textContent = v.name;
          tr.children[1].textContent = v.item;
          const canDelete = auth.currentUser && v.uid === auth.currentUser.uid;
          tr.children[2].textContent = "";
          if (canDelete) {
            const delBtn = document.createElement("button");
            delBtn.className = "btn btn-sm btn-outline-danger";
            delBtn.textContent = "Delete";
            delBtn.addEventListener("click", () => deleteItem(s.key));
            tr.children[2].appendChild(delBtn);
          } else {
            tr.children[2].textContent = "â€”";
          }
        }
      });
    }
  });

  auth.signInAnonymously().catch(e =>
    console.error("anon sign-in failed:", e.code, e.message)
  );

  function renderRow(key, data) {
    if (emptyRow) { emptyRow.remove(); emptyRow = null; }
    const tr = document.createElement("tr");
    tr.dataset.key = key;

    const tdName = document.createElement("td");
    tdName.textContent = data.name;

    const tdItem = document.createElement("td");
    tdItem.textContent = data.item;

    const tdActions = document.createElement("td");
    const canDelete = auth.currentUser && data.uid === auth.currentUser.uid;
    if (canDelete) {
      const delBtn = document.createElement("button");
      delBtn.className = "btn btn-sm btn-outline-danger";
      delBtn.textContent = "DIE!!";
      delBtn.addEventListener("click", () => deleteItem(key));
      tdActions.appendChild(delBtn);
    } else {
      tdActions.textContent = "â€”";
    }

    tr.append(tdName, tdItem, tdActions);
    tbody.appendChild(tr);
  }

  function showEmptyState() {
    if (tbody.querySelector("tr")) return;
    const r = document.createElement("tr");
    r.id = "empty-row";
    const c = document.createElement("td");
    c.colSpan = 3;
    c.className = "text-center muted";
    c.textContent = "Nobody is bringing a single thing yet. (You're number 1!!!)...but I'm pretty sure some items have been deleted...ðŸ‘»";
    r.appendChild(c);
    tbody.appendChild(r);
    emptyRow = r;
    form.reset();
  }

  async function deleteItem(key) {
    if (!confirm("Be so fr. Why are you deleting this?")) return;
    try {
      await itemsRef.child(key).remove();
    } catch (e) {
      alert("Error deleting: " + e.message);
    }
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const user = auth.currentUser;
    if (!user) {
      alert("Still signing in â€” try again in a moment.");
      return;
    }

    const name = nameInput.value.trim();
    const item = itemInput.value.trim();
    if (name.length < 2 || item.length < 2) return;

    try {
      const ref = itemsRef.push();
      await ref.set({ uid: user.uid, name, item, createdAt: Date.now() });
      form.reset();
    } catch (e) {
      console.error("write error:", e);
      alert("Write failed: " + e.message);
    }
  });
</script>

</body>
</html>













